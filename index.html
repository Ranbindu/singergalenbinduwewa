<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Shop Cam</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK - Version 9 Compatibility is used -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        // --- Firebase Config (ඔබේ Firebase විස්තර) ---
        // මෙම කොටස ඔබ Firebase Console එකෙන් ලබාගත් අගයන්ට වෙනස් කරන්න.
        const firebaseConfig = {
            apiKey: "AIzaSyAifmX-sw2S85AdkbEUVnzAk9iOtgJiz4c",
            authDomain: "singer-galenbindunuwewa.firebaseapp.com",
            projectId: "singer-galenbindunuwewa",
            storageBucket: "singer-galenbindunuwewa.firebasestorage.app",
            messagingSenderId: "444869449554",
            appId: "1:444869449554:web:99e66a83595a358a074c8b",
            measurementId: "G-D8E4KB45P8"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Icons (අයිකන) ---
        const Icons = {
            Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            Image: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        };

        const { useState, useEffect, useRef } = React;

        // --- Main App Component ---
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('auth'); 
            const [loading, setLoading] = useState(true);
            const [notification, setNotification] = useState(null);

            // Authentication state listener (පරිශීලක තත්ත්වය සවන්දීම)
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                    setView(currentUser ? 'home' : 'auth');
                });
                return () => unsubscribe();
            }, []);

            // Notification message function (දැනුම්දීම් පෙන්වීම)
            const showNotify = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 4000);
            };

            const handleLogout = async () => {
                await auth.signOut();
                showNotify("Logged out successfully (සාර්ථකව ඉවත් විය)");
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center">System Loading... (පද්ධතිය පූරණය වෙමින් පවතී)</div>;

            return (
                <div className="min-h-screen pb-24">
                    {user && (
                        // Header (ශීර්ෂකය)
                        <header className="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-50">
                            <div className="max-w-md mx-auto flex justify-between items-center">
                                <div className="flex items-center gap-2 font-bold text-lg" onClick={() => setView('home')}>
                                    <Icons.Camera /> <span>Smart Shop Cam</span>
                                </div>
                                <button onClick={handleLogout} className="text-xs bg-blue-700 px-3 py-1.5 rounded flex items-center gap-1">
                                    <Icons.LogOut /> Logout
                                </button>
                            </div>
                        </header>
                    )}

                    <main className="max-w-md mx-auto p-4">
                        {!user ? (
                            // Authentication View (පිවිසුම් තිරය)
                            <AuthView showNotify={showNotify} />
                        ) : (
                            // Main Views (ප්‍රධාන තිර)
                            <>
                                {view === 'home' && <HomeView setView={setView} user={user} />}
                                {view === 'add' && <AddCustomerView user={user} setView={setView} showNotify={showNotify} />}
                                {view === 'search' && <SearchView user={user} setView={setView} showNotify={showNotify} />}
                            </>
                        )}
                    </main>

                    {/* Notification Popup (දැනුම්දීම් පෙට්ටිය) */}
                    {notification && (
                        <div className={`fixed bottom-4 left-4 right-4 p-4 rounded-lg shadow-lg text-white text-center z-50 ${notification.type === 'error' ? 'bg-red-500' : 'bg-green-600'}`}>
                            {notification.msg}
                        </div>
                    )}
                </div>
            );
        }

        // --- Auth Component (පිවිසුම් සහ ලියාපදිංචි වීමේ කොටස) ---
        function AuthView({ showNotify }) {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [processing, setProcessing] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setProcessing(true);
                try {
                    if (isLogin) {
                        await auth.signInWithEmailAndPassword(email, password);
                        showNotify("Welcome back! (නැවත සාදරයෙන් පිළිගනිමු!)");
                    } else {
                        await auth.createUserWithEmailAndPassword(email, password);
                        showNotify("Account created! (ගිණුම සාදන ලදි!)");
                    }
                } catch (error) {
                    showNotify(error.message, "error");
                } finally {
                    setProcessing(false);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-[80vh]">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border">
                        <div className="flex justify-center mb-6"><div className="bg-blue-100 p-4 rounded-full text-blue-600"><Icons.Camera /></div></div>
                        <h2 className="text-2xl font-bold text-center mb-2">{isLogin ? 'Login (පිවිසෙන්න)' : 'Sign Up (ලියාපදිංචි වන්න)'}</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700">Email</label><input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-lg" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Password</label><input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border rounded-lg" required /></div>
                            <button type="submit" disabled={processing} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">{processing ? 'Processing...' : (isLogin ? 'Login' : 'Sign Up')}</button>
                        </form>
                        <button onClick={() => setIsLogin(!isLogin)} className="mt-4 text-blue-600 text-sm w-full text-center hover:underline">{isLogin ? "Need an account? Sign Up" : "Have an account? Login"}</button>
                    </div>
                </div>
            );
        }

        // --- Home Component (මුල් තිරය) ---
        function HomeView({ setView, user }) {
            return (
                <div className="flex flex-col gap-6 mt-8">
                    <div className="text-center mb-4"><h2 className="text-2xl font-bold">Hello!</h2><p className="text-gray-500 text-sm">User: {user.email}</p></div>
                    <button onClick={() => setView('add')} className="flex items-center justify-center gap-4 bg-blue-600 text-white p-6 rounded-2xl shadow-lg active:scale-95 transition-transform">
                        <Icons.Plus /><div className="text-left"><div className="font-bold text-lg">New Customer (නව පාරිභෝගිකයා)</div><div className="text-blue-100 text-sm">Add photos (ඡායාරූප එක් කරන්න)</div></div>
                    </button>
                    <button onClick={() => setView('search')} className="flex items-center justify-center gap-4 bg-white text-gray-700 p-6 rounded-2xl shadow-md border active:scale-95 transition-transform">
                        <Icons.Search /><div className="text-left"><div className="font-bold text-lg">Find Customer (පාරිභෝගිකයා සොයන්න)</div><div className="text-gray-500 text-sm">Search by NIC (NIC මගින් සොයන්න)</div></div>
                    </button>
                </div>
            );
        }

        // --- Add Customer Component (නව පාරිභෝගිකයෙකු ඇතුළත් කිරීම) ---
        function AddCustomerView({ user, setView, showNotify }) {
            const [formData, setFormData] = useState({ name: '', nic: '' });
            const [photos, setPhotos] = useState([]);
            const [isCameraOpen, setIsCameraOpen] = useState(false);
            const [cameraError, setCameraError] = useState(null);
            const [saving, setSaving] = useState(false);
            const videoRef = useRef(null);
            
            // ඡායාරූප සීමාව සහ Compression සැකසුම්
            const MAX_PHOTOS = 3;
            const MAX_WIDTH = 480; 
            const COMPRESSION_QUALITY = 0.4;

            // කැමරාව ආරම්භ කිරීම
            const startCamera = async () => {
                if (photos.length >= MAX_PHOTOS) {
                    return showNotify(`Only ${MAX_PHOTOS} photos allowed. (ඡායාරූප ${MAX_PHOTOS}ක් පමණයි)`, "error");
                }
                setIsCameraOpen(true);
                setCameraError(null);
                try {
                    // ජංගම දුරකථන වල පසුපස කැමරාව භාවිතා කිරීමට 'environment'
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    if (videoRef.current) videoRef.current.srcObject = stream;
                } catch (err) { 
                    console.error(err);
                    setCameraError("Camera blocked! Use HTTPS or Localhost. (කැමරාව අවහිර කර ඇත!)");
                }
            };

            // ඡායාරූපයක් ගැනීම (කැමරාවෙන්)
            const capturePhoto = () => {
                if (!videoRef.current || !videoRef.current.srcObject) return;
                const video = videoRef.current;
                const canvas = document.createElement('canvas');
                
                let width = video.videoWidth;
                let height = video.videoHeight;
                
                // Photo Resizing/Compression Logic
                if (width > MAX_WIDTH) {
                    height = height * (MAX_WIDTH / width);
                    width = MAX_WIDTH;
                }

                canvas.width = width;
                canvas.height = height;
                canvas.getContext('2d').drawImage(video, 0, 0, width, height); 
                
                // Base64 බවට පෙරළීම
                const base64 = canvas.toDataURL('image/jpeg', COMPRESSION_QUALITY); 
                setPhotos([...photos, base64]);
                
                // කැමරාව වසා දැමීම
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                setIsCameraOpen(false);
            };

            const closeCamera = () => {
                if (videoRef.current && videoRef.current.srcObject) {
                    videoRef.current.srcObject.getTracks().forEach(track => track.stop());
                }
                setIsCameraOpen(false);
            }
            
            // --- NEW: Gallery Select Handler (Gallery එකෙන් තේරීමේ කේතය) ---
            const handleGallerySelect = (event) => {
                if (photos.length >= MAX_PHOTOS) {
                    showNotify(`Only ${MAX_PHOTOS} photos allowed. (ඡායාරූප ${MAX_PHOTOS}ක් පමණයි)`, "error");
                    event.target.value = null; // Reset input
                    return;
                }

                const file = event.target.files[0];
                if (!file || !file.type.startsWith('image/')) {
                    showNotify("Please select an image file (ඡායාරූපයක් තෝරන්න)", "error");
                    event.target.value = null;
                    return;
                }

                // File Reader හරහා image එක Base64 බවට හරවයි
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        
                        let width = img.width;
                        let height = img.height;
                        
                        // Image compression (ඡායාරූපය කුඩා කිරීම)
                        if (width > MAX_WIDTH) {
                            height = height * (MAX_WIDTH / width);
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                        
                        // Base64 බවට පෙරළීම
                        const base64 = canvas.toDataURL('image/jpeg', COMPRESSION_QUALITY); 
                        setPhotos(prevPhotos => [...prevPhotos, base64]);
                    };
                    img.onerror = () => showNotify("Error loading image (පින්තූරය පූරණය කිරීමේ දෝෂයක්)", "error");
                    img.src = e.target.result;
                };
                reader.onerror = () => showNotify("Error reading file (File කියවීමේ දෝෂයක්)", "error");
                reader.readAsDataURL(file);
                event.target.value = null; // නැවත තෝරා ගැනීමට හැකි වන පරිදි reset කිරීම
            };
            // -----------------------------------------------------------


            // Customer Save කිරීම
            const handleSave = async () => {
                if (!formData.name || !formData.nic || photos.length === 0) {
                    return showNotify("Fill all details & take photos (සියලු විස්තර පුරවන්න සහ ඡායාරූප ගන්න)", "error");
                }
                setSaving(true);
                
                try {
                    const nic = formData.nic.trim().toUpperCase();
                    // NIC එක Doc ID එක විදියට භාවිතා කිරීම
                    const docRef = db.collection('artifacts').doc('shop-app').collection('users').doc(user.uid).collection('customers').doc(nic);

                    // 1. Check if Customer Exists (දැනටමත් Customer කෙනෙක් ඉන්නවද කියලා පරීක්ෂා කිරීම)
                    const docSnap = await docRef.get();
                    if (docSnap.exists) {
                         showNotify("Customer already exists! Use Search. (මෙම ID අංකය දැනටමත් තිබේ. සොයන්න)", "error");
                         setSaving(false);
                         return; // නැවත Save වීම වළක්වයි
                    }

                    // 2. Save (නව Customer කෙනෙක් නම් පමණක් Save කිරීම)
                    await docRef.set({
                        name: formData.name, 
                        nic: nic, 
                        photos, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showNotify("Saved Successfully! (සාර්ථකව Save කරන ලදි!)"); 
                    setTimeout(() => setView('home'), 1000);

                } catch (e) { 
                    console.error(e);
                    let msg = "Error saving (Save කිරීමේදී දෝෂයක්)";
                    if (e.code === 'permission-denied') msg = "Permission Denied! Fix Rules in Console. (අවසර නැත! Rules හදන්න)";
                    else if(e.code === 'resource-exhausted') msg = "Storage full or Photo too big. (ගබඩාව පිරී ඇත)";
                    else msg = e.message;

                    showNotify(msg, "error");
                } finally {
                    setSaving(false);
                }
            };

            return (
                <div className="flex flex-col h-full">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold">New Customer (නව පාරිභෝගිකයා)</h2><button onClick={() => setView('home')} className="p-2 bg-gray-200 rounded-full"><Icons.X /></button></div>
                    <div className="space-y-4 pb-20">
                        <input type="text" placeholder="NIC Number" className="w-full p-3 border rounded-lg uppercase" value={formData.nic} onChange={e => setFormData({...formData, nic: e.target.value.toUpperCase()})} maxLength={200} />
                        <input type="text" placeholder="Full Name (මුළු නම)" className="w-full p-3 border rounded-lg" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                        
                        <div className="text-gray-600 text-sm font-semibold mt-4">Photos ({photos.length}/{MAX_PHOTOS})</div>
                        <div className="grid grid-cols-3 gap-2">
                            {/* Display Photos (ගන්නා ලද ඡායාරූප) */}
                            {photos.map((p, i) => <div key={i} className="relative aspect-square"><img src={p} className="w-full h-full object-cover rounded-lg" /><button onClick={() => setPhotos(photos.filter((_, idx) => idx !== i))} className="absolute top-0 right-0 bg-red-500 text-white p-1 rounded-full text-xs opacity-70 hover:opacity-100"><Icons.X /></button></div>)}
                            
                            {/* Camera and Gallery Buttons (කැමරා සහ Gallery බොත්තම්) */}
                            {photos.length < MAX_PHOTOS && (
                                <>
                                    {/* Camera Button */}
                                    <button onClick={startCamera} className="aspect-square flex flex-col items-center justify-center bg-blue-50 border-2 border-dashed border-blue-200 text-blue-600 rounded-lg p-2 transition hover:bg-blue-100">
                                        <Icons.Camera /><span className="text-xs mt-1">Camera (කැමරාව)</span>
                                    </button>
                                    
                                    {/* Gallery Button (Gallery එකෙන් තේරීමට) */}
                                    <input 
                                        type="file" 
                                        id="galleryInput" 
                                        accept="image/*" 
                                        onChange={handleGallerySelect} 
                                        className="hidden" 
                                        multiple={false}
                                    />
                                    <button 
                                        onClick={() => document.getElementById('galleryInput').click()} 
                                        className="aspect-square flex flex-col items-center justify-center bg-green-50 border-2 border-dashed border-green-200 text-green-600 rounded-lg p-2 transition hover:bg-green-100"
                                    >
                                        <Icons.Image /><span className="text-xs mt-1">Gallery (ගැලරිය)</span>
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                    {/* Save Button (Save බොත්තම) */}
                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t"><button onClick={handleSave} disabled={saving} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">{saving ? 'Saving...' : 'Save Customer'}</button></div>
                    
                    {/* Camera Modal (කැමරා තිරය) */}
                    {isCameraOpen && (
                        <div className="fixed inset-0 z-50 bg-black flex flex-col">
                            <div className="flex-1 flex items-center justify-center overflow-hidden relative">
                                {cameraError ? (
                                    <div className="text-white text-center p-4">
                                        <div className="text-red-500 text-4xl mb-2">⚠️</div>
                                        <p className="font-bold">Camera Blocked</p>
                                        <p className="text-sm text-gray-400 mt-2">Please use HTTPS or Localhost.</p>
                                    </div>
                                ) : (
                                    <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover" />
                                )}
                                <button onClick={closeCamera} className="absolute top-4 right-4 bg-white/20 p-2 rounded-full text-white"><Icons.X /></button>
                            </div>
                            {!cameraError && (
                                <div className="h-24 flex items-center justify-center bg-black/80">
                                    <button onClick={capturePhoto} className="w-16 h-16 bg-white rounded-full border-4 border-gray-300"></button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // --- Search View Component (සෙවුම් තිරය) ---
        function SearchView({ user, setView, showNotify }) {
            const [searchNic, setSearchNic] = useState('');
            const [result, setResult] = useState(null);
            const [searching, setSearching] = useState(false);

            // Search Logic (සෙවීමේ ක්‍රියාවලිය)
            const handleSearch = async () => {
                if(!searchNic) return;
                setSearching(true); setResult(null);
                try {
                    // NIC එක අනුව Firebase එකෙන් Customer සොයයි
                    const doc = await db.collection('artifacts').doc('shop-app').collection('users').doc(user.uid).collection('customers').doc(searchNic.trim().toUpperCase()).get();
                    if(doc.exists) {
                        setResult(doc.data());
                        showNotify("Customer Found (පාරිභෝගිකයා හමු විය)");
                    }
                    else {
                        showNotify("Customer Not Found (පාරිභෝගිකයා හමු නොවීය)", "error");
                    }
                } catch(e) { 
                    console.error(e);
                    let msg = "Error searching (සෙවීමේදී දෝෂයක්)";
                    if(e.code === 'permission-denied') msg = "Permission Denied! Fix Rules in Console. (අවසර නැත!)";
                    else if(e.code === 'unavailable') msg = "Network Error. Check Internet. (ජාල දෝෂය)";
                    else msg = e.message;
                    
                    showNotify(msg, "error"); 
                }
                setSearching(false);
            };

            return (
                <div className="flex flex-col h-full">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold">Find Customer (පාරිභෝගිකයා සොයන්න)</h2><button onClick={() => setView('home')} className="p-2 bg-gray-200 rounded-full"><Icons.X /></button></div>
                    {/* Search Input (සෙවුම් කොටස) */}
                    <div className="flex gap-2 mb-6"><input type="text" placeholder="Enter NIC (NIC අංකය ඇතුළත් කරන්න)" className="w-full p-3 border rounded-lg uppercase" value={searchNic} onChange={e => setSearchNic(e.target.value.toUpperCase())} /><button onClick={handleSearch} disabled={searching} className="bg-blue-600 text-white px-4 rounded-lg">{searching ? '...' : 'Go (යන්න)'}</button></div>
                    
                    {/* Search Result (සෙවුම් ප්‍රතිඵලය) */}
                    {result && (
                        <div className="bg-white rounded-xl shadow border overflow-hidden">
                            <div className="p-4 bg-gray-50 border-b">
                                <h3 className="font-bold">Name (නම): {result.name}</h3>
                                <p className="text-blue-600 text-sm">NIC (NIC): {result.nic}</p>
                            </div>
                            <div className="p-4 grid grid-cols-2 gap-4">
                                {result.photos.map((p, i) => <img key={i} src={p} className="w-full rounded-lg border shadow-sm" />)}
                            </div>
                            <div className="p-4 text-xs text-gray-500">
                                Saved On: {result.createdAt ? new Date(result.createdAt.seconds * 1000).toLocaleString() : 'N/A'}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
